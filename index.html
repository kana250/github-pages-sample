<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest 3 WebSocket Client</title>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
        }
        canvas {
            display: block;
        }
        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            max-width: 300px;
        }
        button {
            margin: 5px;
            padding: 10px;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div id="info">
        <h3>WebSocket接続状態</h3>
        <p id="status">未接続</p>
        <button id="connectBtn">接続</button>
        <button id="sendBtn" disabled>テストメッセージ送信</button>
        <button id="vrBtn">VRモード開始</button>
        <div id="messages"></div>
    </div>

    <script type="module">
        import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.159.0/build/three.module.js';
        import { VRButton } from 'https://cdn.jsdelivr.net/npm/three@0.159.0/examples/jsm/webxr/VRButton.js';

        // WebSocket接続
        let ws = null;
        const statusEl = document.getElementById('status');
        const messagesEl = document.getElementById('messages');
        
        // PCのIPアドレスを指定（環境に合わせて変更）
        const WS_URL = 'ws://192.168.10.118:8765';

        // 接続ボタン
        document.getElementById('connectBtn').addEventListener('click', () => {
            connectWebSocket();
        });

        // 送信ボタン
        document.getElementById('sendBtn').addEventListener('click', () => {
            if (ws && ws.readyState === WebSocket.OPEN) {
                const data = {
                    type: 'test',
                    message: 'Hello from Quest 3!',
                    timestamp: Date.now()
                };
                ws.send(JSON.stringify(data));
                addMessage('送信: ' + data.message);
            }
        });

        function connectWebSocket() {
            statusEl.textContent = '接続中...';
            
            ws = new WebSocket(WS_URL);

            ws.onopen = () => {
                statusEl.textContent = '接続成功！';
                statusEl.style.color = '#0f0';
                document.getElementById('sendBtn').disabled = false;
                addMessage('WebSocket接続完了');
            };

            ws.onmessage = (event) => {
                addMessage('受信: ' + event.data);
                console.log('PCから受信:', event.data);
            };

            ws.onerror = (error) => {
                statusEl.textContent = '接続エラー';
                statusEl.style.color = '#f00';
                console.error('WebSocketエラー:', error);
            };

            ws.onclose = () => {
                statusEl.textContent = '接続切断';
                statusEl.style.color = '#ff0';
                document.getElementById('sendBtn').disabled = true;
            };
        }

        function addMessage(msg) {
            const p = document.createElement('p');
            p.textContent = msg;
            p.style.fontSize = '12px';
            p.style.margin = '5px 0';
            messagesEl.appendChild(p);
            
            // メッセージが多すぎたら古いものを削除
            if (messagesEl.children.length > 5) {
                messagesEl.removeChild(messagesEl.firstChild);
            }
        }

        // Three.js + WebXRのセットアップ
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x505050);

        const camera = new THREE.PerspectiveCamera(
            75,
            window.innerWidth / window.innerHeight,
            0.1,
            1000
        );
        camera.position.z = 3;

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.xr.enabled = true;
        document.body.appendChild(renderer.domElement);

        // VRボタンを追加
        document.body.appendChild(VRButton.createButton(renderer));

        // 照明
        const light = new THREE.HemisphereLight(0xffffff, 0x444444);
        light.position.set(0, 20, 0);
        scene.add(light);

        // テストキューブ
        const geometry = new THREE.BoxGeometry(0.5, 0.5, 0.5);
        const material = new THREE.MeshStandardMaterial({ color: 0x00ff00 });
        const cube = new THREE.Mesh(geometry, material);
        cube.position.set(0, 1.5, -2);
        scene.add(cube);

        // コントローラーの設定
        const controller1 = renderer.xr.getController(0);
        const controller2 = renderer.xr.getController(1);
        scene.add(controller1);
        scene.add(controller2);

        // コントローラーのトリガーイベント
        controller1.addEventListener('selectstart', () => {
            if (ws && ws.readyState === WebSocket.OPEN) {
                const data = {
                    type: 'controller',
                    hand: 'right',
                    action: 'trigger',
                    position: controller1.position.toArray()
                };
                ws.send(JSON.stringify(data));
                cube.material.color.setHex(Math.random() * 0xffffff);
            }
        });

        controller2.addEventListener('selectstart', () => {
            if (ws && ws.readyState === WebSocket.OPEN) {
                const data = {
                    type: 'controller',
                    hand: 'left',
                    action: 'trigger',
                    position: controller2.position.toArray()
                };
                ws.send(JSON.stringify(data));
                cube.material.color.setHex(Math.random() * 0xffffff);
            }
        });

        // アニメーションループ
        function animate() {
            cube.rotation.x += 0.01;
            cube.rotation.y += 0.01;

            // VRモード中、ヘッドセットの位置をPCに送信（1秒ごと）
            if (renderer.xr.isPresenting && ws && ws.readyState === WebSocket.OPEN) {
                if (!animate.lastSent || Date.now() - animate.lastSent > 1000) {
                    const headsetPos = camera.position;
                    const data = {
                        type: 'headset',
                        position: headsetPos.toArray(),
                        rotation: camera.rotation.toArray()
                    };
                    ws.send(JSON.stringify(data));
                    animate.lastSent = Date.now();
                }
            }

            renderer.render(scene, camera);
        }

        renderer.setAnimationLoop(animate);

        // ウィンドウリサイズ対応
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>